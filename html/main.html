<!DOCTYPE html>
<html>

<head>
    <title>Main Page</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
<h1>Welcome!</h1>
<a href="query.html">Go to query page</a> <br>
<a href="getAllImage.html">Get all images</a> <br>
<div class="upload">
    <h2>Upload Image</h2>
    <form id="form">
        <label for="file">Image File:</label><br>
        <input type="file" id="file" name="file" required><br>
        <input type="submit" value="Upload Image">
    </form>
    <div id="result"></div>
</div>

<script>
    // Parse the URL fragment to get the ID token
    const hashFragment = window.location.hash.substr(1);
    const idToken = new URLSearchParams(hashFragment).get('id_token');
    localStorage.setItem('idToken', idToken);

    async function convertImageToBase64(image) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(",")[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(image);
        });
    }

    async function uploadImage(event) {
        event.preventDefault();
        const image = document.querySelector('#file').files[0];
        const base64Str = await convertImageToBase64(image);
        const payload = {
            name: image.name,
            file: base64Str,
            user_id:"06ef06c8-6500-45bb-af0c-8ddf8fc7fbc5"
        };
        try {
            const response = await fetch("https://rhnlx9ogtj.execute-api.us-east-1.amazonaws.com/pd/image", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify(payload)
            })
            if (!response.ok) {
                throw new Error("upload fail");
            }
            const data = await response.json();
            var result = "<h2>Upload Successful!</h2><p>The uploaded image's name: " + data.name + "</p>";
            $('#result').html(result);
        } catch (error) {
            var result = "<h2>Upload Failed!</h2><p>" + error.message + "</p>";
            $('#result').html(result);
        }
    }

    // Add the event listener to the form
    document.querySelector('#form').addEventListener('submit', uploadImage);

</script>
</body>

</html>
