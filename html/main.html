<!DOCTYPE html>
<html>

<head>
    <title>Main Page</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
<h1>Welcome!</h1>
<div class="upload">
    <h2>Upload Image</h2>
    <form id="form">
        <label for="file">Image File:</label><br>
        <input type="file" id="file" name="file" required><br>
        <input type="submit" value="Upload Image">
    </form>
    <div id="result"></div>
</div>

<script>
    const hashObject = window.location.hash.substring(1).split('&').reduce((result, item) => {
        const parts = item.split('=');
        result[parts[0]] = decodeURIComponent(parts[1]);
        return result;
    }, {});

    const idToken = hashObject.id_token;

    async function convertImageToBase64(image) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(",")[1]);
            reader.onerror = error => reject(error);
            reader.readAsDataURL(image);
        });
    }

    async function uploadImage(event) {
        event.preventDefault();
        const image = document.querySelector('#file').files[0];
        const base64Str = await convertImageToBase64(image);
        const payload = {
            name: image.name,
            file: base64Str
        };
        try {
            const response = await fetch("https://rhnlx9ogtj.execute-api.us-east-1.amazonaws.com/pd/image", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify(payload)
            })
            if (!response.ok) {
                throw new Error("upload fail");
            }
            const data = await response.json();
            var result = "<h2>Upload Successful!</h2><p>The uploaded image's name: " + data.name + "</p>";
            $('#result').html(result);
        } catch (error) {
            var result = "<h2>Upload Failed!</h2><p>" + error.message + "</p>";
            $('#result').html(result);
        }
    }

    document.querySelector('#form').addEventListener('submit', uploadImage);
</script>
</body>

</html>
